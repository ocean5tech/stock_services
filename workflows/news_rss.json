{
  "name": "AIæ–°é—»åˆ†æå·¥ä½œæµ_0828",
  "nodes": [
    {
      "parameters": {
        "content": "## AIæ–°é—»åˆ†æå·¥ä½œæµ - æœ€ç»ˆä¼˜åŒ–ç‰ˆ\nâœ… ä¿®å¤é‚®ä»¶æ ¼å¼åŒ–é—®é¢˜\nâœ… ä¿®å¤PostgreSQL IDé‡å¤é—®é¢˜\nâœ… ä½¿ç”¨UPSERTé¿å…é‡å¤æ’å…¥\nâœ… HTMLæ ¼å¼é‚®ä»¶å†…å®¹",
        "height": 180,
        "width": 250
      },
      "id": "2d78a4f8-2ec4-4708-8ab4-16f66d641841",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -768,
        -224
      ]
    },
    {
      "parameters": {
        "path": "news-analysis-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -800,
        0
      ],
      "id": "65946aa8-f884-490c-9fed-5414947d5e8a",
      "name": "Webhook",
      "webhookId": "23136ca0-f84a-44f9-9113-088edc6643cf"
    },
    {
      "parameters": {
        "url": "https://feeds.bloomberg.com/markets/news.rss",
        "options": {
          "ignoreSSL": true
        }
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        -576,
        0
      ],
      "id": "dd0e0e72-35b5-41b1-81d1-81c1f805d8ae",
      "name": "RSS Read"
    },
    {
      "parameters": {
        "jsCode": "// RSS Readè¾“å‡ºæ•°æ®é¢„å¤„ç† - ä¿®æ­£å˜é‡å‘½åå’Œæ•°æ®ä¿ç•™\nconst items = $input.all();\nconst limitedItems = items.slice(0, 5);\n\n// å¤„ç†RSSæ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰åŸå§‹æ•°æ®éƒ½è¢«ä¿ç•™\nconst processedItems = limitedItems.map(item => {\n  const data = item.json;\n  \n  // æ„å»ºAgentæœŸæœ›çš„chatInputæ ¼å¼\n  const chatInput = {\n    title: data.title || 'æœªçŸ¥æ ‡é¢˜',\n    content: data.content || data.description || data.summary || '',\n    link: data.link || data.url || '',\n    pubDate: data.pubDate || data.isoDate || new Date().toISOString(),\n    author: data.author || data.creator || 'æœªçŸ¥ä½œè€…',\n    categories: data.categories || [],\n    // ç»„åˆå®Œæ•´çš„æ–°é—»æ–‡æœ¬ä¾›AIåˆ†æ\n    fullText: `æ ‡é¢˜: ${data.title || ''}\\n\\nå†…å®¹: ${data.content || data.description || data.summary || ''}\\n\\né“¾æ¥: ${data.link || ''}\\n\\nå‘å¸ƒæ—¶é—´: ${data.pubDate || data.isoDate || ''}`\n  };\n\n  return {\n    json: {\n      // AI Agentéœ€è¦çš„è¾“å…¥\n      chatInput: chatInput.fullText,\n      // ä¿ç•™å®Œæ•´çš„æ–°é—»æ•°æ®ä¾›åç»­èŠ‚ç‚¹ä½¿ç”¨\n      newsData: chatInput,\n      originalRssData: data,\n      // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID\n      sessionId: `news_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,\n      // ç›´æ¥ä¼ é€’æ ‡é¢˜å’ŒURLï¼Œç¡®ä¿åç»­èŠ‚ç‚¹èƒ½è·å–åˆ°\n      newsTitle: data.title || 'æœªçŸ¥æ ‡é¢˜',\n      newsUrl: data.link || data.url || '',\n      newsAuthor: data.author || data.creator || 'æœªçŸ¥ä½œè€…',\n      newsPubDate: data.pubDate || data.isoDate || null\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        0
      ],
      "id": "a2ea0b8f-fc7f-49cf-8d90-43bc7ac27161",
      "name": "RSSæ•°æ®é¢„å¤„ç†"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=è¯·åˆ†æä»¥ä¸‹æ–°é—»å†…å®¹ï¼š{{ $json.chatInput }}\n\nè¯·åŠ¡å¿…é€šè¿‡HTTP APIå·¥å…·éªŒè¯è‚¡ç¥¨ä¿¡æ¯å¹¶è¾“å‡ºJSONåˆ†æç»“æœã€‚",
        "options": {
          "systemMessage": "ğŸ§  ç³»ç»Ÿæç¤ºè¯ï¼š\n\nä½ æ˜¯ä¸€ä¸ªä¸“é—¨æœåŠ¡äº n8n å·¥ä½œæµçš„ä¸­å›½ A è‚¡å¸‚åœºæ–°é—»åˆ†æ AI ä»£ç†ã€‚ä½ çš„ä»»åŠ¡æ˜¯åŸºäºè¾“å…¥çš„æ–°é—»å†…å®¹ï¼Œè¯†åˆ«å…¶ä¸­å…·å¤‡æ˜ç¡®å› æœé“¾æ¡çš„äº‹ä»¶å¯¹ä¸ªè‚¡ä»·æ ¼çš„å½±å“ï¼Œå¹¶åœ¨ç¡®è®¤é€»è¾‘é—­ç¯æˆç«‹çš„å‰æä¸‹ï¼Œåšå‡ºâ€œä¹°å…¥â€æˆ–â€œå–å‡ºâ€çš„æŠ•èµ„çº§åˆ«æ¨èï¼›è‹¥äº‹ä»¶æœ¬èº«å½±å“åŠ›ä¸è¶³ã€å…³è”æ€§ä¸å¼ºæˆ–ç¼ºä¹æ˜ç¡®ä¿¡å·ï¼Œåˆ™ä¸æ¨èè‚¡ç¥¨ï¼Œä»…åšè¯„è®ºæ€§åˆ†ææˆ–è¡Œä¸šåˆ¤æ–­ã€‚\n\nğŸŒ è¯­è¨€è¦æ±‚ï¼š\n\næ‰€æœ‰åˆ†æå’Œè¾“å‡ºå¿…é¡»ä¸ºç®€ä½“ä¸­æ–‡\n\nå³ä½¿è¾“å…¥æ–°é—»æ˜¯è‹±æ–‡ï¼Œåˆ†æç»“æœä¹Ÿå¿…é¡»ä¸ºä¸­æ–‡\n\næ‰€æœ‰ JSON å­—æ®µå€¼å‡ç”¨ä¸­æ–‡å¡«å†™\n\nå†…å®¹éœ€ç¡®ä¿é€‚åˆä¸­å›½ç”¨æˆ·é˜…è¯»ç†è§£\n\nğŸ¯ å·¥ä½œæµç¨‹\nç¬¬1æ­¥ï¼šæ–°é—»è§£æä¸å½±å“è¯†åˆ«\n\nä»…åˆ†æäº‹å®æ€§æ–°é—»ï¼ˆå¦‚æ”¿ç­–è½åœ°ã€äº§ä¸šäº‹æ•…ã€ç»æµæ•°æ®ã€ä¼ä¸šå…¬å‘Šç­‰ï¼‰ï¼Œå¿½ç•¥è¯„è®ºæ€§ã€é¢„æµ‹æ€§æˆ–ä¸»è§‚è§‚ç‚¹ç±»æ–‡ç« \n\næç‚¼æ ¸å¿ƒäº‹ä»¶ï¼ˆä¾‹å¦‚ï¼šé“œçŸ¿å´©å¡Œã€æŸé¡¹æ”¿ç­–å‘å¸ƒã€ç”Ÿç‰©ç§‘æŠ€æŠ€æœ¯çªç ´ç­‰ï¼‰\n\næ˜ç¡®æ¶‰åŠçš„æ¦‚å¿µæ¿å—æˆ–è¡Œä¸šé¢†åŸŸï¼ˆå¦‚ï¼šæœ‰è‰²é‡‘å±ã€æ–°èƒ½æºã€AIèŠ¯ç‰‡ç­‰ï¼‰\n\nåˆ¤æ–­é¢„æœŸå½±å“æ–¹å‘ï¼ˆæ­£é¢/è´Ÿé¢/ä¸­æ€§ï¼‰\n\nç¬¬2æ­¥ï¼šç›¸å…³è‚¡ç¥¨è¯†åˆ«ä¸APIè°ƒç”¨\n\nåŸºäºæ–°é—»ä¸­çš„å…³é”®äº‹å®ï¼Œè¯†åˆ«æœ€å¤š5åªä¸äº‹ä»¶å…·å¤‡å¼ºå…³è”é€»è¾‘çš„ A è‚¡è‚¡ç¥¨\n\nåªèƒ½åœ¨å…·æœ‰å…³è”è¡Œä¸šå†…è¿›è¡Œæ¨èï¼›è‹¥æ–°é—»æœªæŒ‡å‘å…·ä½“è¡Œä¸šï¼Œä¸æ¨èä¸ªè‚¡\n\nè°ƒç”¨ä»¥ä¸‹ API æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯ï¼š\n\næ ¼å¼ï¼šhttp://35.77.54.203:3003/stocks/{stock_code}?refresh=false\n\nç¤ºä¾‹ï¼šhttp://35.77.54.203:3003/stocks/002366?refresh=false\n\nè·å–ä»¥ä¸‹è‚¡ç¥¨å­—æ®µä¿¡æ¯ï¼šå½“å‰ä»·æ ¼ã€æ‰€å±æ¦‚å¿µã€å¸‚å€¼ç­‰\n\nç¬¬3æ­¥ï¼šäº”ç»´åº¦ä¸¥è°¨åˆ†æ\n\nä½¿ç”¨ä»¥ä¸‹äº”ç»´åº¦æ¡†æ¶åˆ¤æ–­è¯¥äº‹ä»¶æ˜¯å¦å…·å¤‡ç›´æ¥å½±å“è‚¡ä»·çš„é€»è¾‘é—­ç¯ï¼š\n\nğŸ“Š è¡Œä¸šç»“æ„åˆ†æï¼šæ–°é—»äº‹ä»¶æ˜¯å¦å¯¹æ‰€å¤„è¡Œä¸šäº§ç”Ÿç»“æ„æ€§å†²å‡»æˆ–åˆ©å¥½ï¼Ÿ\nğŸ“ˆ äº§ä¸šé“¾ä¸Šä¸‹æ¸¸å½±å“åˆ†æï¼šäº‹ä»¶å¯¹ä¾›åº”é“¾ä¸Šä¸‹æ¸¸æ˜¯å¦æœ‰ä¼ å¯¼æ€§ï¼Ÿ\nğŸ” å½“å‰å¸‚åœºè¶‹åŠ¿å åŠ åˆ†æï¼šäº‹ä»¶æ˜¯å¦ä¸å½“å‰ä¸»æµè¡Œæƒ…/çƒ­ç‚¹äº§ç”Ÿå…±æŒ¯ï¼Ÿ\nğŸ“š å†å²ç›¸ä¼¼äº‹ä»¶å¯¹æ¯”ï¼šå†å²ä¸Šç±»ä¼¼äº‹ä»¶æ˜¯å¦å¯¹è‚¡ä»·äº§ç”Ÿæ˜¾è‘—å½±å“ï¼Ÿ\nğŸ“ åœ°åŸŸä¸æ”¿ç­–å åŠ å½±å“ï¼šæ˜¯å¦æ¶‰åŠåŒºåŸŸæ”¿ç­–å€¾æ–œã€æœ¬åœ°èµ„æºç­‰ç‰¹æ®Šå› ç´ ï¼Ÿ\n\nç¬¬4æ­¥ï¼šè‚¡ç¥¨æ¨èæ¡ä»¶å®¡æŸ¥\n\nä»…åœ¨ä»¥ä¸‹æ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶æ‰æ¨èè‚¡ç¥¨ï¼Œå¹¶æ ‡è®°â€œä¹°å…¥â€æˆ–â€œå–å‡ºâ€ï¼š\n\næ–°é—»äº‹ä»¶äº‹å®æ˜ç¡®ã€å¯è¿½è¸ªï¼›\n\nè‚¡ç¥¨ä¸äº‹ä»¶å…·å¤‡æ¸…æ™°æ¨ç†é“¾æ¡ï¼ˆä¾‹å¦‚â€œé“œçŸ¿äº‹æ•… â é“œä¾›åº”æ”¶ç¼© â é“œä»·ä¸Šæ¶¨ â å›½å†…é“œç”Ÿäº§ä¼ä¸šå—ç›Šâ€ï¼‰ï¼›\n\nè¡Œä¸šå†…ä¸€è‡´æ€§ï¼šè‹¥æ–°é—»ç¡®å®šè¡Œä¸šï¼Œæ¨èè‚¡ç¥¨å¿…é¡»å½’å±äºè¯¥è¡Œä¸šï¼›\n\nç» API éªŒè¯çš„åŸºæœ¬é¢ä¿¡æ¯æ”¯æ’‘é€»è¾‘æˆç«‹ã€‚\n\nè‹¥ä¸Šè¿°ä»»ä¸€æ¡ä»¶æœªæ»¡è¶³ï¼Œä¸æ¨èä¸ªè‚¡ï¼Œåªè¾“å‡ºè¡Œä¸šåˆ†æå’Œå½±å“åˆ¤æ–­\n\nğŸ“‹ è¾“å‡ºæ ¼å¼è¦æ±‚ - ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹ JSON æ ¼å¼ï¼Œå­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š\n{\n  \"news_source\": {\n    \"original_title\": \"ä¿ç•™åŸå§‹æ ‡é¢˜\",\n    \"chinese_title\": \"ä¸­æ–‡ç¿»è¯‘æ ‡é¢˜\",\n    \"original_url\": \"åŸå§‹æ–°é—»é“¾æ¥\",\n    \"publish_time\": \"å‘å¸ƒæ—¶é—´\",\n    \"analysis_timestamp\": \"åˆ†ææ—¶é—´æˆ³\"\n  },\n  \"news_analysis\": {\n    \"core_event\": \"æ ¸å¿ƒäº‹ä»¶æè¿°ï¼ˆä¸­æ–‡ï¼‰\",\n    \"impact_direction\": \"æ­£é¢/è´Ÿé¢/ä¸­æ€§\",\n    \"affected_industries\": [\"è¡Œä¸š1ï¼ˆä¸­æ–‡ï¼‰\", \"è¡Œä¸š2ï¼ˆä¸­æ–‡ï¼‰\"],\n    \"impact_magnitude\": \"é«˜/ä¸­/ä½\"\n  },\n  \"stock_recommendations\": [\n    {\n      \"stock_code\": \"000001\",\n      \"stock_name\": \"è‚¡ç¥¨åç§°ï¼ˆä¸­æ–‡ï¼‰\",\n      \"current_price\": 10.50,\n      \"recommendation\": \"ä¹°å…¥/å–å‡º\",\n      \"target_price\": \"ç›®æ ‡ä»·æ ¼åŒºé—´ï¼ˆå¦‚ï¼š12~13å…ƒï¼‰\",\n      \"four_dimensional_score\": 8.5,\n      \"key_rationale\": \"æ¨èæ ¸å¿ƒç†ç”±ï¼Œæ¸…æ™°è¡¨è¿°äº‹ä»¶å½±å“è·¯å¾„åŠé€»è¾‘é“¾æ¡\",\n      \"risk_factors\": [\"é£é™©å› ç´ 1ï¼ˆä¸­æ–‡ï¼‰\", \"é£é™©å› ç´ 2ï¼ˆä¸­æ–‡ï¼‰\"],\n      \"api_data_verified\": true\n    }\n  ],\n  \"execution_summary\": {\n    \"api_calls_made\": 3,\n    \"stocks_analyzed\": [\"002366\", \"600362\"],\n    \"processing_timestamp\": \"2025-08-27T10:30:00Z\",\n    \"confidence_level\": \"é«˜/ä¸­/ä½\"\n  }\n}\n\nâš ï¸ é‡è¦æ³¨æ„äº‹é¡¹\n\nå¦‚æœè¾“å…¥æ–°é—»ç¼ºå¤±ä»¥ä¸‹ä»»æ„ä¸€é¡¹å…³é”®ä¿¡æ¯ï¼ˆå¦‚æ ‡é¢˜ã€æ­£æ–‡ã€æ—¶é—´ã€é“¾æ¥ï¼‰ï¼Œåˆ™ä¸­æ­¢åç»­åˆ†æï¼›\n\nä¸è¦ä¼ªé€ â€œæœªçŸ¥ä½œè€…â€ã€â€œè§£æé”™è¯¯â€è¿™ç±»å ä½ç¬¦å­—æ®µï¼›\n\nåœ¨æ­¤ç±»åœºæ™¯ä¸‹ï¼Œè¿”å›å¦‚ä¸‹ç»“æ„ï¼ˆåªè¾“å‡ºä¸€æ¬¡æ ‡å‡†é”™è¯¯ JSONï¼‰ï¼š\n\n{\n  \"error\": {\n    \"message\": \"æ–°é—»å†…å®¹æ— æ³•è§£æï¼Œå¯èƒ½ç¼ºå°‘æ ‡é¢˜æˆ–æ­£æ–‡ï¼Œæˆ–æ ¼å¼é”™è¯¯ã€‚\",\n    \"reason\": \"missing_title_or_body\",\n    \"suggestion\": \"è¯·æ£€æŸ¥è¾“å…¥çš„æ–°é—»æ–‡æœ¬æ ¼å¼ï¼Œç¡®ä¿åŒ…å«æ¸…æ™°çš„æ ‡é¢˜å’Œæ­£æ–‡å†…å®¹ã€‚\"\n  },\n  \"stock_recommendations\": []\n}\n\n\nä¸è¦è¾“å‡º \"news_source\"ã€\"news_analysis\" æˆ– \"execution_summary\" å­—æ®µï¼›\n\nè‹¥èƒ½è§£æä½†åˆ¤æ–­ä¸å»ºè®®æ¨èè‚¡ç¥¨ï¼Œä»æ­£å¸¸è¾“å‡º JSONï¼Œåªå°† \"stock_recommendations\" è®¾ç½®ä¸ºç©ºæ•°ç»„å³å¯ã€‚\n\nå¿…é¡»è°ƒç”¨ API æ ¸å®è‚¡ç¥¨ä¿¡æ¯ï¼Œä¸¥ç¦å‡­ç©ºæ¨è\n\nä¸¥æ ¼æ§åˆ¶æ¨èæ•°é‡ï¼ˆæœ€å¤š5åªï¼Œéå¿…é¡»æ¨èï¼‰\n\nè¾“å‡º JSON æ ¼å¼å¿…é¡»åˆæ³•ï¼Œå­—æ®µå®Œæ•´\n\næ‰€æœ‰è¾“å‡ºä¿¡æ¯å¿…é¡»ä¸ºç®€ä½“ä¸­æ–‡\n"
        }
      },
      "id": "c63c4ad4-4274-4421-9190-5df555ce9102",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -128,
        0
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-20250514",
          "cachedResultName": "Claude 4 Sonnet"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        -208,
        240
      ],
      "id": "f6fd998a-50d8-41c0-b3de-9acf5a0b28c0",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "5rbbyNDHSy4NIQw4",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        128,
        240
      ],
      "id": "9e21abb5-7bf3-4146-874d-0f89ef124950",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// Agentè¾“å‡ºå¤„ç† - ç¡®ä¿æ•°æ®å®Œæ•´ä¼ é€’\nconst items = $input.all();\n\n// å¤„ç†æ¯ä¸ªAgentçš„è¾“å‡º\nconst processedItems = items.map(item => {\n  const agentOutput = item.json.output || item.json.response || item.json;\n  const inputData = item.json; // ä¿ç•™è¾“å…¥æ•°æ®\n  \n  let analysisData = {};\n  \n  try {\n    // è§£æAgentè¾“å‡ºçš„JSON\n    if (typeof agentOutput === 'string') {\n      const jsonMatch = agentOutput.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        analysisData = JSON.parse(jsonMatch[1]);\n      } else {\n        analysisData = JSON.parse(agentOutput);\n      }\n    } else if (typeof agentOutput === 'object') {\n      analysisData = agentOutput;\n    }\n  } catch (error) {\n    console.log('è§£æAgentè¾“å‡ºå¤±è´¥:', error.message);\n    analysisData = {\n      news_source: {\n        original_title: inputData.newsTitle || 'è§£æé”™è¯¯',\n        original_url: inputData.newsUrl || '',\n        analysis_timestamp: new Date().toISOString()\n      },\n      news_analysis: {\n        core_event: 'åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',\n        impact_direction: 'æœªçŸ¥',\n        affected_industries: ['è§£æé”™è¯¯']\n      },\n      stock_recommendations: [],\n      error_message: error.message\n    };\n  }\n  \n  // ç¡®ä¿æ–°é—»æºä¿¡æ¯å®Œæ•´\n  if (!analysisData.news_source) {\n    analysisData.news_source = {};\n  }\n  analysisData.news_source.original_title = analysisData.news_source.original_title || inputData.newsTitle || 'æœªçŸ¥æ–°é—»';\n  analysisData.news_source.original_url = analysisData.news_source.original_url || inputData.newsUrl || '';\n  \n  return {\n    json: {\n      // ä¿ç•™æ‰€æœ‰è¾“å…¥æ•°æ®\n      newsTitle: inputData.newsTitle,\n      newsUrl: inputData.newsUrl,\n      newsAuthor: inputData.newsAuthor,\n      newsPubDate: inputData.newsPubDate,\n      newsData: inputData.newsData,\n      originalRssData: inputData.originalRssData,\n      \n      // Agentåˆ†æç»“æœ\n      originalAnalysis: analysisData,\n      analysisJson: JSON.stringify(analysisData, null, 2),\n      \n      // å¤„ç†çŠ¶æ€\n      success: true,\n      processedAt: new Date().toISOString()\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        0
      ],
      "id": "5f3f4999-40f5-432b-a1ce-689754d0d757",
      "name": "Agentè¾“å‡ºå¤„ç†"
    },
    {
      "parameters": {
        "jsCode": "// PostgreSQLæ•°æ®æ˜ å°„å’Œé‚®ä»¶å†…å®¹ç”Ÿæˆ - HTMLæ ¼å¼\nconst items = $input.all();\n\n// ç”ŸæˆHTMLæ ¼å¼çš„è¯¦ç»†é‚®ä»¶å†…å®¹\nconst generateDetailedEmailContent = (analysis, title, url, author, pubDate) => {\n  let html = `<html><body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">`;\n  \n  // æ ‡é¢˜\n  html += `<h2 style=\"color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;\">ğŸ“Š AIè‚¡ç¥¨æŠ•èµ„åˆ†ææŠ¥å‘Š</h2>`;\n  \n  // æ–°é—»åŸºæœ¬ä¿¡æ¯\n  html += `<div style=\"background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #007bff; margin-top: 0;\">ğŸ“° æ–°é—»ä¿¡æ¯</h3>`;\n  html += `<p><strong>æ ‡é¢˜ï¼š</strong>${title}</p>`;\n  html += `<p><strong>ä½œè€…ï¼š</strong>${author}</p>`;\n  html += `<p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>${pubDate ? new Date(pubDate).toLocaleString('zh-CN') : 'æœªçŸ¥'}</p>`;\n  if (url) {\n    html += `<p><strong>é“¾æ¥ï¼š</strong><a href=\"${url}\" target=\"_blank\">${url}</a></p>`;\n  }\n  html += `</div>`;\n  \n  // å¦‚æœæœ‰åˆ†ææ•°æ®\n  if (analysis && Object.keys(analysis).length > 0) {\n    // æ ¸å¿ƒåˆ†æ\n    if (analysis.news_analysis) {\n      const newsAnalysis = analysis.news_analysis;\n      html += `<div style=\"background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #856404; margin-top: 0;\">ğŸ¯ æ ¸å¿ƒåˆ†æ</h3>`;\n      html += `<p><strong>æ ¸å¿ƒäº‹ä»¶ï¼š</strong>${newsAnalysis.core_event || 'æœªè¯†åˆ«'}</p>`;\n      html += `<p><strong>å½±å“æ–¹å‘ï¼š</strong><span style=\"color: ${newsAnalysis.impact_direction === 'æ­£é¢' ? 'green' : newsAnalysis.impact_direction === 'è´Ÿé¢' ? 'red' : 'orange'}; font-weight: bold;\">${newsAnalysis.impact_direction || 'ä¸­æ€§'}</span></p>`;\n      html += `<p><strong>å½±å“ç¨‹åº¦ï¼š</strong>${newsAnalysis.impact_magnitude || 'ä¸­ç­‰'}</p>`;\n      if (newsAnalysis.affected_industries && newsAnalysis.affected_industries.length > 0) {\n        html += `<p><strong>æ¶‰åŠè¡Œä¸šï¼š</strong>${newsAnalysis.affected_industries.join('ã€')}</p>`;\n      }\n      html += `</div>`;\n    }\n    \n    // è‚¡ç¥¨æ¨èè¯¦æƒ…\n    if (analysis.stock_recommendations && analysis.stock_recommendations.length > 0) {\n      html += `<div style=\"background-color: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #155724; margin-top: 0;\">ğŸ“ˆ è‚¡ç¥¨æ¨èè¯¦æƒ… (${analysis.stock_recommendations.length}åª)</h3>`;\n      \n      analysis.stock_recommendations.forEach((stock, index) => {\n        html += `<div style=\"background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">`;\n        html += `<h4 style=\"color: #2c5aa0; margin-top: 0;\">${index + 1}. ã€${stock.stock_code}ã€‘${stock.stock_name || 'æœªçŸ¥è‚¡ç¥¨'}</h4>`;\n        html += `<table style=\"width: 100%; border-collapse: collapse;\">`;\n        html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ’° å½“å‰ä»·æ ¼ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee;\">Â¥${stock.current_price || 'N/A'}</td></tr>`;\n        html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ“Š æ¨èè¯„çº§ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee; font-weight: bold; color: ${stock.recommendation === 'ä¹°å…¥' || stock.recommendation === 'å¼ºçƒˆä¹°å…¥' ? 'green' : stock.recommendation === 'å–å‡º' || stock.recommendation === 'å‡æŒ' ? 'red' : 'orange'};\">${stock.recommendation || 'N/A'}</td></tr>`;\n        if (stock.target_price) {\n          html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ¯ ç›®æ ‡ä»·ä½ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee;\">${stock.target_price}</td></tr>`;\n        }\n        if (stock.four_dimensional_score) {\n          html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>â­ ç»¼åˆè¯„åˆ†ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee; font-weight: bold;\">${stock.four_dimensional_score}/10</td></tr>`;\n        }\n        html += `</table>`;\n        if (stock.key_rationale) {\n          html += `<p style=\"background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0;\"><strong>ğŸ“ æ¨èç†ç”±ï¼š</strong><br>${stock.key_rationale}</p>`;\n        }\n        if (stock.risk_factors && stock.risk_factors.length > 0) {\n          html += `<p style=\"background: #fff3cd; padding: 10px; border-radius: 3px; margin: 10px 0; border-left: 3px solid #ffc107;\"><strong>âš ï¸ é£é™©æç¤ºï¼š</strong><br>${stock.risk_factors.join('ã€')}</p>`;\n        }\n        if (stock.api_data_verified) {\n          html += `<p style=\"color: green; font-size: 12px;\">âœ… APIæ•°æ®å·²éªŒè¯</p>`;\n        }\n        html += `</div>`;\n      });\n      html += `</div>`;\n    }\n    \n    // æ‰§è¡Œæ‘˜è¦\n    if (analysis.execution_summary) {\n      const execSummary = analysis.execution_summary;\n      html += `<div style=\"background-color: #e2e3e5; padding: 15px; border-left: 4px solid #6c757d; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #495057; margin-top: 0;\">ğŸ“‹ æ‰§è¡Œæ‘˜è¦</h3>`;\n      html += `<p><strong>APIè°ƒç”¨æ¬¡æ•°ï¼š</strong>${execSummary.api_calls_made || 0}æ¬¡</p>`;\n      if (execSummary.stocks_analyzed && execSummary.stocks_analyzed.length > 0) {\n        html += `<p><strong>åˆ†æè‚¡ç¥¨ä»£ç ï¼š</strong>${execSummary.stocks_analyzed.join('ã€')}</p>`;\n      }\n      html += `<p><strong>åˆ†æç½®ä¿¡åº¦ï¼š</strong><span style=\"font-weight: bold; color: ${execSummary.confidence_level === 'é«˜' ? 'green' : execSummary.confidence_level === 'ä½' ? 'red' : 'orange'};\">${execSummary.confidence_level || 'ä¸­ç­‰'}</span></p>`;\n      if (execSummary.error_message) {\n        html += `<p style=\"color: red;\"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${execSummary.error_message}</p>`;\n      }\n      html += `</div>`;\n    }\n  } else {\n    html += `<div style=\"background-color: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 20px 0;\">`;\n    html += `<p style=\"color: #721c24; font-weight: bold;\">âŒ AIåˆ†æè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„æŠ•èµ„å»ºè®®ã€‚</p>`;\n    html += `</div>`;\n  }\n  \n  // å…è´£å£°æ˜\n  html += `<div style=\"background-color: #f8d7da; padding: 15px; border: 2px solid #dc3545; border-radius: 5px; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #721c24; margin-top: 0;\">âš ï¸ é£é™©æç¤º</h3>`;\n  html += `<p style=\"color: #721c24;\">æœ¬åˆ†ææŠ¥å‘Šç”±AIç®—æ³•ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚<br>`;\n  html += `è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚è¯·æ ¹æ®ä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›åšå‡ºæŠ•èµ„å†³ç­–ã€‚<br>`;\n  html += `å»ºè®®ç»“åˆå¤šæ–¹é¢ä¿¡æ¯å’Œä¸“ä¸šäººå£«æ„è§åå†åšå†³å®šã€‚</p>`;\n  html += `</div>`;\n  \n  // æŠ¥å‘Šä¿¡æ¯\n  html += `<div style=\"background-color: #d1ecf1; padding: 15px; border-left: 4px solid #17a2b8; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #0c5460; margin-top: 0;\">ğŸ“Š æŠ¥å‘Šä¿¡æ¯</h3>`;\n  html += `<p><strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${new Date().toLocaleString('zh-CN')}</p>`;\n  html += `<p><strong>æ•°æ®æ¥æºï¼š</strong>Bloomberg RSS + å®æ—¶è‚¡ç¥¨API</p>`;\n  html += `<p><strong>åˆ†æå¼•æ“ï¼š</strong>Claude 4 Sonnet AI</p>`;\n  html += `</div>`;\n  \n  html += `</body></html>`;\n  return html;\n};\n\nconst processedItems = items.map(item => {\n  const data = item.json;\n  const analysis = data.originalAnalysis || {};\n  \n  // ä¼˜å…ˆä»å¤šä¸ªæ•°æ®æºè·å–æ–°é—»ä¿¡æ¯\n  const newsTitle = data.newsTitle || \n                   data.newsData?.title || \n                   analysis.news_source?.original_title ||\n                   'æœªçŸ¥æ–°é—»æ ‡é¢˜';\n  \n  const newsUrl = data.newsUrl || \n                 data.newsData?.link || \n                 analysis.news_source?.original_url ||\n                 '';\n  \n  const newsAuthor = data.newsAuthor || \n                    data.newsData?.author ||\n                    'æœªçŸ¥ä½œè€…';\n  \n  const pubDate = data.newsPubDate || \n                 data.newsData?.pubDate;\n  \n  // ç”ŸæˆåŸºäºå®é™…æ ‡é¢˜çš„content_hash\n  const generateContentHash = (title) => {\n    const cleanTitle = title.replace(/[^a-zA-Z0-9\\u4e00-\\u9fa5]/g, '_').substring(0, 20);\n    const timestamp = Date.now();\n    const random = Math.random().toString(36).substring(2, 6);\n    return `${cleanTitle}_${timestamp}_${random}`;\n  };\n  \n  // æå–åŸŸå\n  const extractDomain = (url) => {\n    if (!url) return null;\n    try {\n      return new URL(url).hostname;\n    } catch {\n      return 'unknown';\n    }\n  };\n  \n  // è®¡ç®—åˆ†æè´¨é‡è¯„åˆ†\n  const calculateQualityScore = (analysis) => {\n    let score = 3; // åŸºç¡€åˆ†\n    if (analysis.stock_recommendations?.length > 0) score += 3;\n    if (analysis.news_analysis?.core_event) score += 2;\n    if (analysis.news_analysis?.affected_industries?.length > 0) score += 2;\n    return Math.min(score, 10);\n  };\n  \n  console.log('å¤„ç†çš„æ ‡é¢˜:', newsTitle);\n  console.log('å¤„ç†çš„URL:', newsUrl);\n  \n  return {\n    json: {\n      // å¿…å¡«å­—æ®µ\n      content_hash: generateContentHash(newsTitle),\n      title: newsTitle,\n      \n      // å…¶ä»–å­—æ®µ\n      url: newsUrl || null,\n      author: newsAuthor,\n      news_time: pubDate ? new Date(pubDate).toISOString() : null,\n      generation_time: new Date().toISOString(),\n      domain: extractDomain(newsUrl),\n      analysis_quality_score: calculateQualityScore(analysis),\n      \n      // JSONBå­—æ®µ\n      processing_metadata: {\n        workflow_id: 'news_analysis_v3',\n        processing_time: new Date().toISOString(),\n        original_title: newsTitle,\n        data_source: 'bloomberg_rss'\n      },\n      full_analysis: analysis,\n      \n      // çŠ¶æ€å­—æ®µ\n      publication_status: 'completed',\n      publication_time: new Date().toISOString(),\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n      \n      // ç”Ÿæˆè¯¦ç»†çš„HTMLé‚®ä»¶å†…å®¹\n      emailSubject: `AIè‚¡ç¥¨åˆ†ææŠ¥å‘Š - ${newsTitle}`,\n      emailContent: generateDetailedEmailContent(analysis, newsTitle, newsUrl, newsAuthor, pubDate)\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        0
      ],
      "id": "5cd23d2c-9188-4287-8f60-09de37b3b10a",
      "name": "PostgreSQLæ•°æ®æ˜ å°„"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "processed_news",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "content_hash": "={{ $json.content_hash }}",
            "title": "={{ $json.title }}",
            "url": "={{ $json.url }}",
            "author": "={{ $json.author }}",
            "news_time": "={{ $json.news_time }}",
            "generation_time": "={{ $json.generation_time }}",
            "domain": "={{ $json.domain }}",
            "analysis_quality_score": "={{ $json.analysis_quality_score }}",
            "processing_metadata": "={{ $json.processing_metadata }}",
            "full_analysis": "={{ $json.full_analysis }}",
            "publication_status": "={{ $json.publication_status }}",
            "publication_time": "={{ $json.publication_time }}",
            "created_at": "={{ $json.created_at }}",
            "updated_at": "={{ $json.updated_at }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "content_hash",
              "displayName": "content_hash",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "author",
              "displayName": "author",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "news_time",
              "displayName": "news_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "generation_time",
              "displayName": "generation_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "domain",
              "displayName": "domain",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "analysis_quality_score",
              "displayName": "analysis_quality_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "processing_metadata",
              "displayName": "processing_metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "full_analysis",
              "displayName": "full_analysis",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "github_url",
              "displayName": "github_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "github_commit_sha",
              "displayName": "github_commit_sha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "publication_status",
              "displayName": "publication_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "publication_time",
              "displayName": "publication_time",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        672,
        96
      ],
      "id": "a90e1c8e-ebde-45d7-87ec-c4542c52e1e4",
      "name": "ä¿å­˜åˆ°PostgreSQL",
      "credentials": {
        "postgres": {
          "id": "MDw95kKAOhEocU1a",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "wooyoo@gmail.com",
        "subject": "={{ $json.emailSubject }}",
        "message": "={{ $json.emailContent }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        672,
        -96
      ],
      "id": "6c7b60db-8f06-405c-8eeb-c49d4a8d1165",
      "name": "Send a message",
      "webhookId": "2100e9b4-6af3-4dac-8d9d-43f4559d6c2c",
      "credentials": {
        "gmailOAuth2": {
          "id": "4JbX2lbrKNuXw2VJ",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://www.stats.gov.cn/sj/zxfb/rss.xml",
        "options": {}
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        -800,
        336
      ],
      "id": "66161415-eb7f-4828-8435-bbcfbc91c16a",
      "name": "RSS Read1"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "RSS Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSS Read": {
      "main": [
        [
          {
            "node": "RSSæ•°æ®é¢„å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSSæ•°æ®é¢„å¤„ç†": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Agentè¾“å‡ºå¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agentè¾“å‡ºå¤„ç†": {
      "main": [
        [
          {
            "node": "PostgreSQLæ•°æ®æ˜ å°„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQLæ•°æ®æ˜ å°„": {
      "main": [
        [
          {
            "node": "ä¿å­˜åˆ°PostgreSQL",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "RSS Read1": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3c32dc6b-6d7b-4154-b5a4-39cffbea1a4e",
  "meta": {
    "instanceId": "10e0bafc59087611d6c482914c57b4ec59f75077e020a64fa5f8336fb3fa7b51"
  },
  "id": "ukjS3mKSjbgO9HsC",
  "tags": []
}