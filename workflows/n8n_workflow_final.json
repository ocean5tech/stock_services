{
  "name": "AIæ–°é—»åˆ†æå·¥ä½œæµ - æœ€ç»ˆä¼˜åŒ–ç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "content": "## AIæ–°é—»åˆ†æå·¥ä½œæµ - æœ€ç»ˆä¼˜åŒ–ç‰ˆ\nâœ… ä¿®å¤é‚®ä»¶æ ¼å¼åŒ–é—®é¢˜\nâœ… ä¿®å¤PostgreSQL IDé‡å¤é—®é¢˜\nâœ… ä½¿ç”¨UPSERTé¿å…é‡å¤æ’å…¥\nâœ… HTMLæ ¼å¼é‚®ä»¶å†…å®¹",
        "height": 180,
        "width": 250
      },
      "id": "d0aee33f-27a8-4f36-be23-ad4c31966163",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [144, -128]
    },
    {
      "parameters": {
        "path": "news-analysis-webhook",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [192, 192],
      "id": "1935d7b7-2009-48d0-ac2d-939d2af6bec3",
      "name": "Webhook",
      "webhookId": "23136ca0-f84a-44f9-9113-088edc6643cf"
    },
    {
      "parameters": {
        "url": "https://feeds.bloomberg.com/markets/news.rss",
        "options": {
          "ignoreSSL": true
        }
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [416, 192],
      "id": "4d5b320a-0851-4661-8d2f-d5013d68e876",
      "name": "RSS Read"
    },
    {
      "parameters": {
        "jsCode": "// RSS Readè¾“å‡ºæ•°æ®é¢„å¤„ç† - ä¿®æ­£å˜é‡å‘½åå’Œæ•°æ®ä¿ç•™\nconst items = $input.all();\nconst limitedItems = items.slice(0, 2);\n\n// å¤„ç†RSSæ•°æ®ï¼Œç¡®ä¿æ‰€æœ‰åŸå§‹æ•°æ®éƒ½è¢«ä¿ç•™\nconst processedItems = limitedItems.map(item => {\n  const data = item.json;\n  \n  // æ„å»ºAgentæœŸæœ›çš„chatInputæ ¼å¼\n  const chatInput = {\n    title: data.title || 'æœªçŸ¥æ ‡é¢˜',\n    content: data.content || data.description || data.summary || '',\n    link: data.link || data.url || '',\n    pubDate: data.pubDate || data.isoDate || new Date().toISOString(),\n    author: data.author || data.creator || 'æœªçŸ¥ä½œè€…',\n    categories: data.categories || [],\n    // ç»„åˆå®Œæ•´çš„æ–°é—»æ–‡æœ¬ä¾›AIåˆ†æ\n    fullText: `æ ‡é¢˜: ${data.title || ''}\\n\\nå†…å®¹: ${data.content || data.description || data.summary || ''}\\n\\né“¾æ¥: ${data.link || ''}\\n\\nå‘å¸ƒæ—¶é—´: ${data.pubDate || data.isoDate || ''}`\n  };\n\n  return {\n    json: {\n      // AI Agentéœ€è¦çš„è¾“å…¥\n      chatInput: chatInput.fullText,\n      // ä¿ç•™å®Œæ•´çš„æ–°é—»æ•°æ®ä¾›åç»­èŠ‚ç‚¹ä½¿ç”¨\n      newsData: chatInput,\n      originalRssData: data,\n      // ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ID\n      sessionId: `news_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,\n      // ç›´æ¥ä¼ é€’æ ‡é¢˜å’ŒURLï¼Œç¡®ä¿åç»­èŠ‚ç‚¹èƒ½è·å–åˆ°\n      newsTitle: data.title || 'æœªçŸ¥æ ‡é¢˜',\n      newsUrl: data.link || data.url || '',\n      newsAuthor: data.author || data.creator || 'æœªçŸ¥ä½œè€…',\n      newsPubDate: data.pubDate || data.isoDate || null\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 192],
      "id": "17f5859e-d429-483e-857a-f068a43f8f74",
      "name": "RSSæ•°æ®é¢„å¤„ç†"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=è¯·åˆ†æä»¥ä¸‹æ–°é—»å†…å®¹ï¼š{{ $json.chatInput }}\n\nè¯·åŠ¡å¿…é€šè¿‡HTTP APIå·¥å…·éªŒè¯è‚¡ç¥¨ä¿¡æ¯å¹¶è¾“å‡ºJSONåˆ†æç»“æœã€‚",
        "options": {
          "systemMessage": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­å›½è‚¡å¸‚æ–°é—»åˆ†æå¸ˆã€‚è¯·ç”¨ä¸­æ–‡åˆ†ææ–°é—»å†…å®¹ï¼Œæ¯æ¡æ–°é—»é™åˆ¶åˆ†æ3åªè‚¡ç¥¨ã€‚\n\nğŸ¯ å·¥ä½œæµç¨‹\n- ä½¿ç”¨HTTP APIå·¥å…·æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯\n- APIæ ¼å¼ï¼šhttp://35.77.54.203:3003/stocks/{stock_code}?refresh=false\n- è¾“å‡ºJSONæ ¼å¼çš„åˆ†æç»“æœ\n\nğŸ“‹ è¾“å‡ºæ ¼å¼ï¼š\n```json\n{\n  \"news_source\": {\n    \"original_title\": \"åŸå§‹æ ‡é¢˜\",\n    \"original_url\": \"åŸå§‹é“¾æ¥\",\n    \"analysis_timestamp\": \"åˆ†ææ—¶é—´\"\n  },\n  \"news_analysis\": {\n    \"core_event\": \"æ ¸å¿ƒäº‹ä»¶æè¿°\",\n    \"impact_direction\": \"æ­£é¢/è´Ÿé¢/ä¸­æ€§\",\n    \"affected_industries\": [\"ç›¸å…³è¡Œä¸š\"],\n    \"impact_magnitude\": \"é«˜/ä¸­/ä½\"\n  },\n  \"stock_recommendations\": [\n    {\n      \"stock_code\": \"è‚¡ç¥¨ä»£ç \",\n      \"stock_name\": \"è‚¡ç¥¨åç§°\",\n      \"current_price\": ä»·æ ¼,\n      \"recommendation\": \"ä¹°å…¥/æŒæœ‰/å–å‡º\",\n      \"target_price\": \"ç›®æ ‡ä»·æ ¼\",\n      \"key_rationale\": \"æ¨èç†ç”±\",\n      \"risk_factors\": [\"é£é™©å› ç´ \"],\n      \"api_data_verified\": true\n    }\n  ],\n  \"execution_summary\": {\n    \"api_calls_made\": 3,\n    \"stocks_analyzed\": [\"è‚¡ç¥¨ä»£ç åˆ—è¡¨\"],\n    \"confidence_level\": \"é«˜/ä¸­/ä½\"\n  }\n}\n```"
        }
      },
      "id": "419dc1b2-0573-4061-9bab-650d518c6509",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [928, 192]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-sonnet-4-20250514",
          "cachedResultName": "Claude 4 Sonnet"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [864, 416],
      "id": "c238ee03-f4f1-4ed2-b8d6-319c7357615b",
      "name": "Anthropic Chat Model",
      "credentials": {
        "anthropicApi": {
          "id": "5rbbyNDHSy4NIQw4",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1120, 416],
      "id": "d768d420-e5f4-4314-99f5-97bcc99ad93d",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// Agentè¾“å‡ºå¤„ç† - ç¡®ä¿æ•°æ®å®Œæ•´ä¼ é€’\nconst items = $input.all();\n\n// å¤„ç†æ¯ä¸ªAgentçš„è¾“å‡º\nconst processedItems = items.map(item => {\n  const agentOutput = item.json.output || item.json.response || item.json;\n  const inputData = item.json; // ä¿ç•™è¾“å…¥æ•°æ®\n  \n  let analysisData = {};\n  \n  try {\n    // è§£æAgentè¾“å‡ºçš„JSON\n    if (typeof agentOutput === 'string') {\n      const jsonMatch = agentOutput.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n      if (jsonMatch) {\n        analysisData = JSON.parse(jsonMatch[1]);\n      } else {\n        analysisData = JSON.parse(agentOutput);\n      }\n    } else if (typeof agentOutput === 'object') {\n      analysisData = agentOutput;\n    }\n  } catch (error) {\n    console.log('è§£æAgentè¾“å‡ºå¤±è´¥:', error.message);\n    analysisData = {\n      news_source: {\n        original_title: inputData.newsTitle || 'è§£æé”™è¯¯',\n        original_url: inputData.newsUrl || '',\n        analysis_timestamp: new Date().toISOString()\n      },\n      news_analysis: {\n        core_event: 'åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯',\n        impact_direction: 'æœªçŸ¥',\n        affected_industries: ['è§£æé”™è¯¯']\n      },\n      stock_recommendations: [],\n      error_message: error.message\n    };\n  }\n  \n  // ç¡®ä¿æ–°é—»æºä¿¡æ¯å®Œæ•´\n  if (!analysisData.news_source) {\n    analysisData.news_source = {};\n  }\n  analysisData.news_source.original_title = analysisData.news_source.original_title || inputData.newsTitle || 'æœªçŸ¥æ–°é—»';\n  analysisData.news_source.original_url = analysisData.news_source.original_url || inputData.newsUrl || '';\n  \n  return {\n    json: {\n      // ä¿ç•™æ‰€æœ‰è¾“å…¥æ•°æ®\n      newsTitle: inputData.newsTitle,\n      newsUrl: inputData.newsUrl,\n      newsAuthor: inputData.newsAuthor,\n      newsPubDate: inputData.newsPubDate,\n      newsData: inputData.newsData,\n      originalRssData: inputData.originalRssData,\n      \n      // Agentåˆ†æç»“æœ\n      originalAnalysis: analysisData,\n      analysisJson: JSON.stringify(analysisData, null, 2),\n      \n      // å¤„ç†çŠ¶æ€\n      success: true,\n      processedAt: new Date().toISOString()\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1328, 192],
      "id": "0b473ac2-666a-44fe-b042-b9ad71a27c76",
      "name": "Agentè¾“å‡ºå¤„ç†"
    },
    {
      "parameters": {
        "jsCode": "// PostgreSQLæ•°æ®æ˜ å°„å’Œé‚®ä»¶å†…å®¹ç”Ÿæˆ - HTMLæ ¼å¼\nconst items = $input.all();\n\n// ç”ŸæˆHTMLæ ¼å¼çš„è¯¦ç»†é‚®ä»¶å†…å®¹\nconst generateDetailedEmailContent = (analysis, title, url, author, pubDate) => {\n  let html = `<html><body style=\"font-family: Arial, sans-serif; line-height: 1.6; color: #333;\">`;\n  \n  // æ ‡é¢˜\n  html += `<h2 style=\"color: #2c5aa0; border-bottom: 2px solid #2c5aa0; padding-bottom: 10px;\">ğŸ“Š AIè‚¡ç¥¨æŠ•èµ„åˆ†ææŠ¥å‘Š</h2>`;\n  \n  // æ–°é—»åŸºæœ¬ä¿¡æ¯\n  html += `<div style=\"background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #007bff; margin-top: 0;\">ğŸ“° æ–°é—»ä¿¡æ¯</h3>`;\n  html += `<p><strong>æ ‡é¢˜ï¼š</strong>${title}</p>`;\n  html += `<p><strong>ä½œè€…ï¼š</strong>${author}</p>`;\n  html += `<p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>${pubDate ? new Date(pubDate).toLocaleString('zh-CN') : 'æœªçŸ¥'}</p>`;\n  if (url) {\n    html += `<p><strong>é“¾æ¥ï¼š</strong><a href=\"${url}\" target=\"_blank\">${url}</a></p>`;\n  }\n  html += `</div>`;\n  \n  // å¦‚æœæœ‰åˆ†ææ•°æ®\n  if (analysis && Object.keys(analysis).length > 0) {\n    // æ ¸å¿ƒåˆ†æ\n    if (analysis.news_analysis) {\n      const newsAnalysis = analysis.news_analysis;\n      html += `<div style=\"background-color: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #856404; margin-top: 0;\">ğŸ¯ æ ¸å¿ƒåˆ†æ</h3>`;\n      html += `<p><strong>æ ¸å¿ƒäº‹ä»¶ï¼š</strong>${newsAnalysis.core_event || 'æœªè¯†åˆ«'}</p>`;\n      html += `<p><strong>å½±å“æ–¹å‘ï¼š</strong><span style=\"color: ${newsAnalysis.impact_direction === 'æ­£é¢' ? 'green' : newsAnalysis.impact_direction === 'è´Ÿé¢' ? 'red' : 'orange'}; font-weight: bold;\">${newsAnalysis.impact_direction || 'ä¸­æ€§'}</span></p>`;\n      html += `<p><strong>å½±å“ç¨‹åº¦ï¼š</strong>${newsAnalysis.impact_magnitude || 'ä¸­ç­‰'}</p>`;\n      if (newsAnalysis.affected_industries && newsAnalysis.affected_industries.length > 0) {\n        html += `<p><strong>æ¶‰åŠè¡Œä¸šï¼š</strong>${newsAnalysis.affected_industries.join('ã€')}</p>`;\n      }\n      html += `</div>`;\n    }\n    \n    // è‚¡ç¥¨æ¨èè¯¦æƒ…\n    if (analysis.stock_recommendations && analysis.stock_recommendations.length > 0) {\n      html += `<div style=\"background-color: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #155724; margin-top: 0;\">ğŸ“ˆ è‚¡ç¥¨æ¨èè¯¦æƒ… (${analysis.stock_recommendations.length}åª)</h3>`;\n      \n      analysis.stock_recommendations.forEach((stock, index) => {\n        html += `<div style=\"background: white; padding: 15px; margin: 10px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">`;\n        html += `<h4 style=\"color: #2c5aa0; margin-top: 0;\">${index + 1}. ã€${stock.stock_code}ã€‘${stock.stock_name || 'æœªçŸ¥è‚¡ç¥¨'}</h4>`;\n        html += `<table style=\"width: 100%; border-collapse: collapse;\">`;\n        html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ’° å½“å‰ä»·æ ¼ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee;\">Â¥${stock.current_price || 'N/A'}</td></tr>`;\n        html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ“Š æ¨èè¯„çº§ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee; font-weight: bold; color: ${stock.recommendation === 'ä¹°å…¥' || stock.recommendation === 'å¼ºçƒˆä¹°å…¥' ? 'green' : stock.recommendation === 'å–å‡º' || stock.recommendation === 'å‡æŒ' ? 'red' : 'orange'};\">${stock.recommendation || 'N/A'}</td></tr>`;\n        if (stock.target_price) {\n          html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>ğŸ¯ ç›®æ ‡ä»·ä½ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee;\">${stock.target_price}</td></tr>`;\n        }\n        if (stock.four_dimensional_score) {\n          html += `<tr><td style=\"padding: 5px; border-bottom: 1px solid #eee;\"><strong>â­ ç»¼åˆè¯„åˆ†ï¼š</strong></td><td style=\"padding: 5px; border-bottom: 1px solid #eee; font-weight: bold;\">${stock.four_dimensional_score}/10</td></tr>`;\n        }\n        html += `</table>`;\n        if (stock.key_rationale) {\n          html += `<p style=\"background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0;\"><strong>ğŸ“ æ¨èç†ç”±ï¼š</strong><br>${stock.key_rationale}</p>`;\n        }\n        if (stock.risk_factors && stock.risk_factors.length > 0) {\n          html += `<p style=\"background: #fff3cd; padding: 10px; border-radius: 3px; margin: 10px 0; border-left: 3px solid #ffc107;\"><strong>âš ï¸ é£é™©æç¤ºï¼š</strong><br>${stock.risk_factors.join('ã€')}</p>`;\n        }\n        if (stock.api_data_verified) {\n          html += `<p style=\"color: green; font-size: 12px;\">âœ… APIæ•°æ®å·²éªŒè¯</p>`;\n        }\n        html += `</div>`;\n      });\n      html += `</div>`;\n    }\n    \n    // æ‰§è¡Œæ‘˜è¦\n    if (analysis.execution_summary) {\n      const execSummary = analysis.execution_summary;\n      html += `<div style=\"background-color: #e2e3e5; padding: 15px; border-left: 4px solid #6c757d; margin: 20px 0;\">`;\n      html += `<h3 style=\"color: #495057; margin-top: 0;\">ğŸ“‹ æ‰§è¡Œæ‘˜è¦</h3>`;\n      html += `<p><strong>APIè°ƒç”¨æ¬¡æ•°ï¼š</strong>${execSummary.api_calls_made || 0}æ¬¡</p>`;\n      if (execSummary.stocks_analyzed && execSummary.stocks_analyzed.length > 0) {\n        html += `<p><strong>åˆ†æè‚¡ç¥¨ä»£ç ï¼š</strong>${execSummary.stocks_analyzed.join('ã€')}</p>`;\n      }\n      html += `<p><strong>åˆ†æç½®ä¿¡åº¦ï¼š</strong><span style=\"font-weight: bold; color: ${execSummary.confidence_level === 'é«˜' ? 'green' : execSummary.confidence_level === 'ä½' ? 'red' : 'orange'};\">${execSummary.confidence_level || 'ä¸­ç­‰'}</span></p>`;\n      if (execSummary.error_message) {\n        html += `<p style=\"color: red;\"><strong>é”™è¯¯ä¿¡æ¯ï¼š</strong>${execSummary.error_message}</p>`;\n      }\n      html += `</div>`;\n    }\n  } else {\n    html += `<div style=\"background-color: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 20px 0;\">`;\n    html += `<p style=\"color: #721c24; font-weight: bold;\">âŒ AIåˆ†æè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œæœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„æŠ•èµ„å»ºè®®ã€‚</p>`;\n    html += `</div>`;\n  }\n  \n  // å…è´£å£°æ˜\n  html += `<div style=\"background-color: #f8d7da; padding: 15px; border: 2px solid #dc3545; border-radius: 5px; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #721c24; margin-top: 0;\">âš ï¸ é£é™©æç¤º</h3>`;\n  html += `<p style=\"color: #721c24;\">æœ¬åˆ†ææŠ¥å‘Šç”±AIç®—æ³•ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚<br>`;\n  html += `è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚è¯·æ ¹æ®ä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›åšå‡ºæŠ•èµ„å†³ç­–ã€‚<br>`;\n  html += `å»ºè®®ç»“åˆå¤šæ–¹é¢ä¿¡æ¯å’Œä¸“ä¸šäººå£«æ„è§åå†åšå†³å®šã€‚</p>`;\n  html += `</div>`;\n  \n  // æŠ¥å‘Šä¿¡æ¯\n  html += `<div style=\"background-color: #d1ecf1; padding: 15px; border-left: 4px solid #17a2b8; margin: 20px 0;\">`;\n  html += `<h3 style=\"color: #0c5460; margin-top: 0;\">ğŸ“Š æŠ¥å‘Šä¿¡æ¯</h3>`;\n  html += `<p><strong>ç”Ÿæˆæ—¶é—´ï¼š</strong>${new Date().toLocaleString('zh-CN')}</p>`;\n  html += `<p><strong>æ•°æ®æ¥æºï¼š</strong>Bloomberg RSS + å®æ—¶è‚¡ç¥¨API</p>`;\n  html += `<p><strong>åˆ†æå¼•æ“ï¼š</strong>Claude 4 Sonnet AI</p>`;\n  html += `</div>`;\n  \n  html += `</body></html>`;\n  return html;\n};\n\nconst processedItems = items.map(item => {\n  const data = item.json;\n  const analysis = data.originalAnalysis || {};\n  \n  // ä¼˜å…ˆä»å¤šä¸ªæ•°æ®æºè·å–æ–°é—»ä¿¡æ¯\n  const newsTitle = data.newsTitle || \n                   data.newsData?.title || \n                   analysis.news_source?.original_title ||\n                   'æœªçŸ¥æ–°é—»æ ‡é¢˜';\n  \n  const newsUrl = data.newsUrl || \n                 data.newsData?.link || \n                 analysis.news_source?.original_url ||\n                 '';\n  \n  const newsAuthor = data.newsAuthor || \n                    data.newsData?.author ||\n                    'æœªçŸ¥ä½œè€…';\n  \n  const pubDate = data.newsPubDate || \n                 data.newsData?.pubDate;\n  \n  // ç”ŸæˆåŸºäºå®é™…æ ‡é¢˜çš„content_hash\n  const generateContentHash = (title) => {\n    const cleanTitle = title.replace(/[^a-zA-Z0-9\\u4e00-\\u9fa5]/g, '_').substring(0, 20);\n    const timestamp = Date.now();\n    const random = Math.random().toString(36).substring(2, 6);\n    return `${cleanTitle}_${timestamp}_${random}`;\n  };\n  \n  // æå–åŸŸå\n  const extractDomain = (url) => {\n    if (!url) return null;\n    try {\n      return new URL(url).hostname;\n    } catch {\n      return 'unknown';\n    }\n  };\n  \n  // è®¡ç®—åˆ†æè´¨é‡è¯„åˆ†\n  const calculateQualityScore = (analysis) => {\n    let score = 3; // åŸºç¡€åˆ†\n    if (analysis.stock_recommendations?.length > 0) score += 3;\n    if (analysis.news_analysis?.core_event) score += 2;\n    if (analysis.news_analysis?.affected_industries?.length > 0) score += 2;\n    return Math.min(score, 10);\n  };\n  \n  console.log('å¤„ç†çš„æ ‡é¢˜:', newsTitle);\n  console.log('å¤„ç†çš„URL:', newsUrl);\n  \n  return {\n    json: {\n      // å¿…å¡«å­—æ®µ\n      content_hash: generateContentHash(newsTitle),\n      title: newsTitle,\n      \n      // å…¶ä»–å­—æ®µ\n      url: newsUrl || null,\n      author: newsAuthor,\n      news_time: pubDate ? new Date(pubDate).toISOString() : null,\n      generation_time: new Date().toISOString(),\n      domain: extractDomain(newsUrl),\n      analysis_quality_score: calculateQualityScore(analysis),\n      \n      // JSONBå­—æ®µ\n      processing_metadata: {\n        workflow_id: 'news_analysis_v3',\n        processing_time: new Date().toISOString(),\n        original_title: newsTitle,\n        data_source: 'bloomberg_rss'\n      },\n      full_analysis: analysis,\n      \n      // çŠ¶æ€å­—æ®µ\n      publication_status: 'completed',\n      publication_time: new Date().toISOString(),\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n      \n      // ç”Ÿæˆè¯¦ç»†çš„HTMLé‚®ä»¶å†…å®¹\n      emailSubject: `AIè‚¡ç¥¨åˆ†ææŠ¥å‘Š - ${newsTitle}`,\n      emailContent: generateDetailedEmailContent(analysis, newsTitle, newsUrl, newsAuthor, pubDate)\n    }\n  };\n});\n\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1536, 192],
      "id": "cfab6eca-68fc-413f-b044-436460554cbc",
      "name": "PostgreSQLæ•°æ®æ˜ å°„"
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "processed_news",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "content_hash": "={{ $json.content_hash }}",
            "title": "={{ $json.title }}",
            "url": "={{ $json.url }}",
            "author": "={{ $json.author }}",
            "news_time": "={{ $json.news_time }}",
            "generation_time": "={{ $json.generation_time }}",
            "domain": "={{ $json.domain }}",
            "analysis_quality_score": "={{ $json.analysis_quality_score }}",
            "processing_metadata": "={{ $json.processing_metadata }}",
            "full_analysis": "={{ $json.full_analysis }}",
            "publication_status": "={{ $json.publication_status }}",
            "publication_time": "={{ $json.publication_time }}",
            "created_at": "={{ $json.created_at }}",
            "updated_at": "={{ $json.updated_at }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1760, 272],
      "id": "177dda36-afea-4f28-84d6-db9d91d1e72c",
      "name": "ä¿å­˜åˆ°PostgreSQL",
      "credentials": {
        "postgres": {
          "id": "MDw95kKAOhEocU1a",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "wooyoo@gmail.com",
        "subject": "={{ $json.emailSubject }}",
        "message": "={{ $json.emailContent }}",
        "options": {
          "isBodyHtml": true
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1760, 112],
      "id": "62bd6541-7598-439a-849a-9ab4da9dbb71",
      "name": "Send a message",
      "webhookId": "2100e9b4-6af3-4dac-8d9d-43f4559d6c2c",
      "credentials": {
        "gmailOAuth2": {
          "id": "4JbX2lbrKNuXw2VJ",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "RSS Read",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSS Read": {
      "main": [
        [
          {
            "node": "RSSæ•°æ®é¢„å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSSæ•°æ®é¢„å¤„ç†": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Agentè¾“å‡ºå¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agentè¾“å‡ºå¤„ç†": {
      "main": [
        [
          {
            "node": "PostgreSQLæ•°æ®æ˜ å°„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQLæ•°æ®æ˜ å°„": {
      "main": [
        [
          {
            "node": "ä¿å­˜åˆ°PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Anthropic Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "tags": ["AIåˆ†æ", "æ–°é—»", "è‚¡ç¥¨", "æœ€ç»ˆä¼˜åŒ–"]
}